## IpTables

- **iptables** is used to intercept and process **IP packets** at the **node** level (for all namespaces and interfaces). The rules constitute a `firewall` in the usual sense, but are implemented in the kernel by [Netfilter](connection_tracking.md).

####
- Every packets is considered either: **in**coming, **out**going or **for**warded



    #####
    - **Intercepts**:

        ####
        - **Outgoing** packets 
            - **after**  leaving (**post-routing**) network socket (but before they are sent out through the network interface)
            - This allows it to potentially *send* the packet to a different destination (socket) than initially intended.

        ####
        - **Incoming** packets 
            - **before** reaching (**pre-routing**) network socket (but after they arrive at the network interface)
            - This allows it to potentially *deliver* the packet to a different destination than initially intended.

        ####
        - **Forwarded** packets 
            - **both** *before* and *after*
    #### 
    - **Processes**: 
        - It can **drop**, or **modify** packets based on configurable `rules`.
            - Possible modifications include rewriting the source (src) and destination (dst) addresses, to or from that of internal or external interfaces.

###
- Limits & Alternatives
    - **`Layer 3/4` only**  - so cant distinguish different (layer 7) protocols
        - Deep Packet Inspection (DPI) tools like nDPI, Suricata are alternatives for this

    - The developers of the Netfilter project have created [nftables](https://en.wikipedia.org/wiki/Nftables), which is intended to be a replacement for iptables
    

##
- ### Structure 
    `Tables` contain one or more `Chains`, which in turn contain `Rules`.

    See [packet processing](https://ww2.coastal.edu/mmurphy2/oer/iptables/introduction/#figure-3)




    ##
    - #### Chains
        - A chain is a sequence of rules that packets are checked against in a specific order.

            #####
            - **Built-in chains**:

                - Forwarded packets goes through both, incoming only the former, and outgoing only the latter of:
                    - **`PREROUTING`**: The **first** chain a packet hits. 
                    Before routing decisions are made.
                    
                    ###
                    - **`POSTROUTING`**: The **last** chain a packet hits. 
                    After routing decisions are made.

                ###
                - and exactly one of:
                    - **`INPUT`**: Handles packets destined for the local system.
                    - **`OUTPUT`**: Handles packets generated by the local system.
                    - **`FORWARD`**: Handles packets routed through the system (not destined for or originating from the local system).

    - #### Tables
        - Contain collections of chains:
 
            - **`filter`**: The **default** table, used for packet filtering (e.g., accepting or dropping packets). This is the only table that can DROP a packet (the others just allow modification of some kind).

            #####
            - **`nat`**: Used for Network Address Translation (NAT), modifying source or destination addresses of packets.
            - **`mangle`**: Used for specialized packet alterations, such as modifying IP headers.
            - **`raw`**: Used for configuring exemptions from connection tracking.
            - **`security`**: Used for enforcing Mandatory Access Control (MAC) security policies, like SELinux or AppArmor.


            ###
           -  A packet can be visualized as traveling from **top-left** to **bottom-right** one **_row_** (containing its packet type: (in, out, for) _at a time_ 

                |&#x2B07; Chain    | `Raw` Table | `Mangle` Table | `NAT` Table | `Filter` Table | `Security` Table |
                |--------------|--------------|-----------|--------------|-----------|----------------|
                | `PREROUTING` (in, for)  | &#x2713;  | &#x2713;        | &#x2713;       |            |                    |
                | `INPUT` (in)      |         | &#x2713;        |         | &#x2713;       | &#x2713;             |
                | `OUTPUT`(out)      | &#x2713;  | &#x2713;        | &#x2713;       | &#x2713;       | &#x2713;             |
                | `FORWARD` (for)     |         | &#x2713;        |         | &#x2713;       | &#x2713;             |
                | `POSTROUTING` (out, for)  |         | &#x2713;        | &#x2713;       |            |                    |



            ##
            - **User-defined chains**:
                - Custom chains created to organize and manage rules more efficiently. These can be jumped to from built-in chains using the `-j` option.

                - **Jumping Between Chains**:
                    - Rules in a chain can direct the processing of packets to another chain using the `-j` (jump) option.
                    - After processing in the jumped-to chain is complete, control returns to the original chain, similar to how a function call works in programming.
